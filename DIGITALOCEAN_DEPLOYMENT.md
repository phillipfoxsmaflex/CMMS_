# DigitalOcean App Platform Deployment Guide

This guide will help you deploy your MMS (Maintenance Management System) application to DigitalOcean's App Platform.

## üìã Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [App.yaml Files](#appyaml-files)
4. [Deployment Methods](#deployment-methods)
5. [Configuration Steps](#configuration-steps)
6. [Post-Deployment](#post-deployment)
7. [Troubleshooting](#troubleshooting)
8. [Cost Estimation](#cost-estimation)

---

## üéØ Overview

Your application consists of the following components:

- **Frontend**: React application served by Nginx
- **API**: Spring Boot backend application
- **PostgreSQL**: Managed database for application data
- **InfluxDB**: Time-series database for metrics
- **Grafana**: Visualization and analytics dashboard
- **Object Storage**: MinIO or DigitalOcean Spaces

---

## ‚úÖ Prerequisites

Before deploying, ensure you have:

1. **DigitalOcean Account** with billing enabled
2. **GitHub Repository** with your code pushed
3. **GitHub Access Token** or OAuth connection to DigitalOcean
4. **Domain Name** (optional, but recommended for production)
5. **Environment Variables** configured (see Configuration section)

---

## üìÑ App.yaml Files

Two versions of `app.yaml` are provided:

### `app.yaml` (with MinIO)
- Uses MinIO container for object storage
- Good for testing and development
- **‚ö†Ô∏è WARNING**: Data may not persist between deployments
- Lower cost but less reliable

### `app.yaml.spaces` (with DigitalOcean Spaces)
- Uses DigitalOcean Spaces (S3-compatible storage)
- **Recommended for production**
- Data persists reliably
- Integrated with CDN for better performance

**Choose the appropriate file based on your needs!**

---

## üöÄ Deployment Methods

### Method 1: Using DigitalOcean Console (Recommended for First-Time)

1. **Login to DigitalOcean Console**
   - Navigate to: https://cloud.digitalocean.com/

2. **Create New App**
   - Go to Apps ‚Üí Create App
   - Choose "GitHub" as source
   - Authorize DigitalOcean to access your repository

3. **Select Repository**
   - Choose your repository
   - Select the branch (usually `main`)

4. **Upload app.yaml**
   - In the app creation wizard, look for "Edit Your App Spec"
   - Copy the contents of `app.yaml` or `app.yaml.spaces`
   - Paste into the editor
   - Update the repository name: `YOUR_GITHUB_USERNAME/YOUR_REPO_NAME`

5. **Review and Update Environment Variables**
   - Update all SECRET variables with actual values
   - Update GitHub repository references
   - Review and adjust instance sizes

6. **Deploy**
   - Click "Create Resources"
   - Wait for deployment to complete (10-15 minutes)

### Method 2: Using doctl CLI

```bash
# Install doctl (DigitalOcean CLI)
# macOS
brew install doctl

# Linux
cd ~
wget https://github.com/digitalocean/doctl/releases/download/v1.98.1/doctl-1.98.1-linux-amd64.tar.gz
tar xf ~/doctl-1.98.1-linux-amd64.tar.gz
sudo mv ~/doctl /usr/local/bin

# Authenticate
doctl auth init

# Create app from spec
cd CMMS_
doctl apps create --spec app.yaml

# Or with Spaces version
doctl apps create --spec app.yaml.spaces
```

### Method 3: GitHub Integration (Continuous Deployment)

Once your app is created, DigitalOcean will automatically deploy on every push to your main branch.

To enable this:
1. Ensure `deploy_on_push: true` is set in app.yaml
2. Push changes to your repository
3. App Platform will detect changes and redeploy automatically

---

## ‚öôÔ∏è Configuration Steps

### Step 1: Update GitHub Repository Reference

In your chosen `app.yaml` file, replace:
```yaml
github:
  repo: YOUR_GITHUB_USERNAME/YOUR_REPO_NAME
```

With your actual repository, for example:
```yaml
github:
  repo: johndoe/mms-application
```

### Step 2: Configure Environment Variables

#### Required Secrets (Must Update):

1. **Database Credentials** (Auto-generated by managed DB, but you can customize):
   - `DB_USER`
   - `DB_PWD`

2. **Security**:
   - `JWT_SECRET_KEY` - Generate a strong random string (32+ characters)
   ```bash
   # Generate a secure JWT secret
   openssl rand -base64 32
   ```

3. **Object Storage** (if using Spaces):
   - `AWS_ACCESS_KEY_ID` - From DigitalOcean Spaces Keys
   - `AWS_SECRET_ACCESS_KEY` - From DigitalOcean Spaces Keys
   - Update Space name and region

4. **Database Passwords**:
   - `INFLUXDB_PASSWORD`
   - `INFLUXDB_ADMIN_TOKEN`
   - `GRAFANA_ADMIN_PASSWORD`

#### Optional Configuration:

5. **Email** (if enabling notifications):
   - `SMTP_USER`
   - `SMTP_PWD`
   - `SMTP_HOST`
   - `SMTP_PORT`
   - Set `ENABLE_EMAIL_NOTIFICATIONS=true`

6. **SSO** (if enabling single sign-on):
   - `OAUTH2_CLIENT_ID`
   - `OAUTH2_CLIENT_SECRET`
   - `OAUTH2_PROVIDER`
   - Set `ENABLE_SSO=true`

7. **FastSpring** (if using payment processing):
   - `FASTSPRING_USER`
   - `FASTSPRING_PWD`

### Step 3: Set Up DigitalOcean Spaces (if using app.yaml.spaces)

1. **Create a Space**:
   ```
   Console ‚Üí Spaces ‚Üí Create a Space
   ```
   - Choose region (e.g., NYC3, SFO3)
   - Name your space (e.g., `mms-storage`)
   - Set access: Private (recommended) or Public
   - Enable CDN (optional, for faster global access)

2. **Generate Access Keys**:
   ```
   Console ‚Üí API ‚Üí Spaces Keys ‚Üí Generate New Key
   ```
   - Save the Access Key ID and Secret Key
   - Update these in app.yaml.spaces:
     - `AWS_ACCESS_KEY_ID`
     - `AWS_SECRET_ACCESS_KEY`

3. **Update Space Configuration**:
   ```yaml
   - key: AWS_S3_ENDPOINT
     value: "https://nyc3.digitaloceanspaces.com"  # Your region
   - key: AWS_S3_BUCKET
     value: "mms-storage"  # Your space name
   - key: PUBLIC_MINIO_ENDPOINT
     value: "https://mms-storage.nyc3.digitaloceanspaces.com"
   ```

4. **Configure CORS** (if frontend needs direct access):
   ```
   Space Settings ‚Üí CORS Configurations
   ```
   Add allowed origins:
   ```
   Origin: https://your-frontend-url.ondigitalocean.app
   Allowed Methods: GET, PUT, POST, DELETE
   Allowed Headers: *
   ```

### Step 4: Adjust Resource Sizing

Based on your traffic and budget, adjust instance sizes:

```yaml
instance_size_slug: basic-xxs  # Options:
```

Available instance sizes:
- `basic-xxs`: $5/month (512 MB RAM)
- `basic-xs`: $10/month (1 GB RAM)
- `basic-s`: $20/month (2 GB RAM)
- `basic-m`: $40/month (4 GB RAM)
- `professional-xs`: $50/month (1 GB RAM, dedicated)
- `professional-s`: $100/month (2 GB RAM, dedicated)

Recommendations:
- **Frontend**: `basic-xxs` (start small, scale up if needed)
- **API**: `basic-xs` or `basic-s` (depends on traffic)
- **InfluxDB**: `basic-xs` (time-series can be resource-intensive)
- **Grafana**: `basic-xxs` (lightweight)
- **MinIO**: `basic-xxs` (if using, otherwise remove)

### Step 5: Database Configuration

The managed PostgreSQL database in app.yaml is configured as:
```yaml
databases:
  - name: db
    engine: PG
    version: "16"
    production: false  # ‚ö†Ô∏è Set to true for production!
    cluster_name: mms-db-cluster
    db_name: mms
    db_user: rootUser
```

**Important**:
- Set `production: true` for production deployments (enables daily backups)
- Production databases start at $15/month
- Development databases (production: false) start at $7/month

---

## üéâ Post-Deployment

### 1. Access Your Application

After deployment, DigitalOcean will provide URLs for each service:

- **Frontend**: `https://your-app-name.ondigitalocean.app`
- **API**: `https://your-app-name.ondigitalocean.app/api`
- **Grafana**: `https://your-app-name.ondigitalocean.app/grafana`
- **InfluxDB**: `https://your-app-name.ondigitalocean.app/influxdb`

### 2. Configure Custom Domain (Optional)

1. Go to your app in DigitalOcean console
2. Navigate to "Settings" ‚Üí "Domains"
3. Add your custom domain
4. Update DNS records as instructed
5. SSL certificate will be automatically provisioned

Update environment variables after domain setup:
```yaml
- key: PUBLIC_API_URL
  value: https://yourdomain.com/api
- key: PUBLIC_FRONT_URL
  value: https://yourdomain.com
```

### 3. Initial Setup Tasks

1. **Access Grafana**:
   - URL: `https://your-app-url/grafana`
   - Username: `admin`
   - Password: (the one you set in `GRAFANA_ADMIN_PASSWORD`)
   - Configure datasources (InfluxDB, PostgreSQL)

2. **Access InfluxDB**:
   - URL: `https://your-app-url/influxdb`
   - Use the admin token you configured
   - Verify the organization and bucket are created

3. **Test Object Storage**:
   - Upload a test file through your application
   - Verify it appears in your Space (if using Spaces)

4. **Verify Database Connection**:
   - Check API logs in DigitalOcean console
   - Ensure database migrations ran successfully
   - Create a test user/record in your application

### 4. Monitor Your Application

- **App Platform Console**: View logs, metrics, and resource usage
- **Set Up Alerts**: Configure alerts for service failures
- **Enable Application Monitoring**: Consider Datadog or other APM tools

---

## üîß Troubleshooting

### Service Won't Start

**Problem**: Service fails to start or crashes immediately

**Solutions**:
1. Check logs in DigitalOcean console (Runtime Logs)
2. Verify all required environment variables are set
3. Check health check paths are correct
4. Ensure build completed successfully (Build Logs)
5. Verify instance size is sufficient

### Database Connection Errors

**Problem**: API can't connect to database

**Solutions**:
1. Verify database is running (check Databases section in console)
2. Check `DB_URL` format: `hostname:port/database_name`
3. Use database credentials from DigitalOcean (they auto-populate as `${db.HOSTNAME}`, etc.)
4. Ensure database and API are in the same app

### Build Failures

**Problem**: Frontend or API build fails

**Solutions**:
1. Check Build Logs for specific errors
2. Verify Dockerfile paths are correct
3. Ensure all build dependencies are in repository
4. Check if build timeouts (increase instance size for build)
5. Verify `source_dir` and `dockerfile_path` are correct

### Storage/MinIO Issues

**Problem**: File uploads fail or files disappear

**Solutions**:
1. If using MinIO container, data won't persist - switch to Spaces
2. Verify `STORAGE_TYPE` is set correctly
3. Check Space access keys are valid
4. Verify Space permissions (should allow uploads)
5. Check CORS configuration if direct frontend uploads

### Grafana Not Loading

**Problem**: Grafana shows errors or won't load

**Solutions**:
1. Check `GF_SERVER_ROOT_URL` matches actual URL
2. Verify `GF_SERVER_SERVE_FROM_SUB_PATH` is `true`
3. Check datasource configuration
4. Ensure InfluxDB and PostgreSQL are accessible
5. Check Grafana logs for specific errors

### Environment Variables Not Working

**Problem**: Changes to environment variables don't take effect

**Solutions**:
1. Redeploy the app after changing variables
2. Variables marked as SECRET must be updated in console (not yaml)
3. Ensure no typos in variable names
4. Check if application reads environment variables correctly

---

## üí∞ Cost Estimation

### Minimum Configuration (Development/Testing)

| Component | Instance Size | Monthly Cost |
|-----------|---------------|--------------|
| Frontend | basic-xxs | $5 |
| API | basic-xs | $10 |
| InfluxDB | basic-xs | $10 |
| Grafana | basic-xxs | $5 |
| PostgreSQL | Dev DB | $7 |
| Spaces (if used) | 250GB + Transfer | $5 |
| **Total** | | **~$42/month** |

### Recommended Production Configuration

| Component | Instance Size | Monthly Cost |
|-----------|---------------|--------------|
| Frontend | basic-xs | $10 |
| API | basic-s | $20 |
| InfluxDB | basic-s | $20 |
| Grafana | basic-xs | $10 |
| PostgreSQL | Production DB | $15+ |
| Spaces + CDN | 250GB + Transfer | $5-15 |
| **Total** | | **~$80-100/month** |

### Cost Optimization Tips

1. **Start Small**: Begin with smaller instances and scale up based on actual usage
2. **Monitor Usage**: Use DigitalOcean's monitoring to identify bottlenecks
3. **Remove Unused Services**: If you don't need Grafana initially, remove it
4. **Use Spaces Instead of MinIO**: More cost-effective for storage
5. **Auto-scaling**: Enable auto-scaling for services with variable load
6. **Development Database**: Use non-production database for testing
7. **Optimize Builds**: Faster builds = lower costs

---

## üìö Additional Resources

- [DigitalOcean App Platform Documentation](https://docs.digitalocean.com/products/app-platform/)
- [App Spec Reference](https://docs.digitalocean.com/products/app-platform/reference/app-spec/)
- [DigitalOcean Spaces Guide](https://docs.digitalocean.com/products/spaces/)
- [doctl CLI Reference](https://docs.digitalocean.com/reference/doctl/)

---

## üÜò Support

If you encounter issues:

1. Check DigitalOcean's status page: https://status.digitalocean.com/
2. Review the troubleshooting section above
3. Check application logs in the DigitalOcean console
4. Contact DigitalOcean support (available 24/7 for paid accounts)
5. Review this application's documentation and README

---

## üìù Deployment Checklist

Before going to production, ensure:

- [ ] All SECRET environment variables are updated with strong values
- [ ] JWT_SECRET_KEY is a strong random string
- [ ] Database is set to production mode (`production: true`)
- [ ] Using DigitalOcean Spaces (not MinIO) for object storage
- [ ] Custom domain is configured with SSL
- [ ] Health checks are properly configured
- [ ] Monitoring and alerts are set up
- [ ] All passwords are changed from defaults
- [ ] CORS is properly configured for your domain
- [ ] Backup strategy is in place for database
- [ ] Resource sizing is appropriate for expected load
- [ ] Application has been tested in staging environment
- [ ] Cost monitoring is enabled
- [ ] Team has access to DigitalOcean console

---

**Good luck with your deployment! üöÄ**
